<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Olive Farm Pro V8</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --main-green: #2d5a27; --accent: #d4a017; }
        body { 
            background: url('https://images.unsplash.com/photo-1500382017468-9049fee74a62?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80') no-repeat center center fixed; 
            background-size: cover;
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            padding-bottom: 80px;
        }
        .overlay { background: rgba(248, 253, 248, 0.85); min-height: 100vh; position: relative; }
        .top-bar { background: linear-gradient(135deg, var(--main-green), #1b3a18); color: white; padding: 20px 15px; border-radius: 0 0 35px 35px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .weather-card { background: white; border-radius: 15px; padding: 12px; margin-top: -25px; border: 1px solid #e0eee0; font-size: 0.9rem; z-index: 10; position: relative; }
        .stat-card { background: white; border-radius: 20px; padding: 15px; border: none; box-shadow: 0 8px 15px rgba(0,0,0,0.1); text-align: center; }
        .btn-action { border: none; border-radius: 18px; padding: 18px 5px; font-weight: 700; color: white; display: flex; flex-direction: column; align-items: center; gap: 10px; font-size: 1rem; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .btn-action:active { transform: scale(0.92); }
        .bottom-nav { background: white; padding: 12px; border-top: 1px solid #eee; position: fixed; bottom: 0; width: 100%; display: flex; justify-content: space-around; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .modal-content { border-radius: 25px; border: none; }
        .log-item { background: white; border-radius: 15px; margin-bottom: 10px; padding: 12px; border-right: 5px solid var(--main-green); }
    </style>
</head>
<body>
<div class="overlay">
    <div class="top-bar text-center">
        <h3 id="farmName" class="fw-bold mb-0">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h3>
        <small id="locStatus" class="opacity-75"><i class="fas fa-map-marker-alt"></i> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</small>
    </div>

    <div class="container px-4">
        <div class="weather-card shadow-sm d-flex justify-content-between align-items-center mb-4 mx-2">
            <div id="weatherInfo">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù‚Ø³...</div>
            <button class="btn btn-sm btn-outline-success border-0" onclick="getWeather()"><i class="fas fa-sync"></i></button>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-6"><div class="stat-card"> <small class="text-muted">Ø§Ù„Ù…Ø­ØµÙˆÙ„</small> <h4 id="kgView" class="mb-0 text-success fw-bold">0</h4> <small>ÙƒØ¬Ù…</small> </div></div>
            <div class="col-6"><div class="stat-card"> <small class="text-muted">Ø§Ù„Ù…Ø®Ø²Ù†</small> <h4 id="stockView" class="mb-0 text-primary fw-bold">0</h4> <small>ÙˆØ­Ø¯Ø©</small> </div></div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-4"><button class="btn-action w-100" style="background:#27ae60" onclick="showInput('Ø±ÙŠ')"><i class="fas fa-droplet fs-4"></i> Ø±ÙŠ</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#f39c12" onclick="showInput('ØªØ³Ù…ÙŠØ¯')"><i class="fas fa-flask fs-4"></i> ØªØ³Ù…ÙŠØ¯</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#9b59b6" onclick="showInput('Ø±Ø´')"><i class="fas fa-wind fs-4"></i> Ø±Ø´</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#e74c3c" onclick="showInput('Ø£Ø¹Ø·Ø§Ù„')"><i class="fas fa-tools fs-4"></i> Ø£Ø¹Ø·Ø§Ù„</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#2c3e50" onclick="showInput('Ø­ØµØ§Ø¯')"><i class="fas fa-box-open fs-4"></i> Ø­ØµØ§Ø¯</button></div>
            <div class="col-4"><button class="btn-action w-100" style="background:#34495e" onclick="downloadReport()"><i class="fas fa-file-alt fs-4"></i> ØªÙ‚Ø±ÙŠØ±</button></div>
        </div>

        <div class="pb-5">
            <h6 class="fw-bold mb-3"><i class="fas fa-camera"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…ØµÙˆØ±:</h6>
            <div id="logList"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="dataModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mx-3">
        <div class="modal-content shadow">
            <div class="modal-header border-0"><h5 id="modalLabel" class="fw-bold"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body pt-0">
                <div id="inputArea"></div>
                <div class="mt-3">
                    <label class="small fw-bold">ğŸ“¸ Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ù„Ù„Ø¹Ù…Ù„ÙŠØ©:</label>
                    <input type="file" id="fileIn" class="form-control" accept="image/*">
                </div>
                <button id="saveBtn" class="btn btn-success w-100 mt-4 py-3 fw-bold rounded-4" onclick="handleSave()">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mx-3">
        <div class="modal-content">
            <div class="modal-header"><h5 class="fw-bold">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <label class="fw-bold mb-2 small text-muted">Ø¥Ø¶Ø§ÙØ© Ù…Ø²Ø±Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©:</label>
                <div class="input-group mb-4">
                    <input type="text" id="newFarmName" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø²Ø±Ø¹Ø©...">
                    <button class="btn btn-success" onclick="createNewFarm()"><i class="fas fa-plus"></i></button>
                </div>
                <hr>
                <button class="btn btn-outline-dark w-100 mb-3 text-end" onclick="exportJSON()"><i class="fas fa-download"></i> ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
                <button class="btn btn-outline-danger w-100 text-end" onclick="resetAll()"><i class="fas fa-trash"></i> Ù…Ø³Ø­ Ø´Ø§Ù…Ù„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <button class="btn text-success" onclick="window.scrollTo(0,0)"><i class="fas fa-home fs-4"></i></button>
    <button class="btn text-secondary" onclick="openFarmsList()"><i class="fas fa-layer-group fs-4"></i></button>
    <button class="btn text-secondary" onclick="showInput('ØªØ°ÙƒÙŠØ±')"><i class="fas fa-bell fs-4"></i></button>
    <button class="btn text-secondary" onclick="openSettings()"><i class="fas fa-cog fs-4"></i></button>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let db = JSON.parse(localStorage.getItem('farm_pro_v8')) || {
        cur: 'f1',
        farms: { 'f1': { name: "Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ø²ÙŠØªÙˆÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", logs: [], kg: 0, stock: 0, lat:null, lon:null } }
    };
    const dModal = new bootstrap.Modal(document.getElementById('dataModal'));
    const sModal = new bootstrap.Modal(document.getElementById('settingsModal'));
    let activeType = '';

    function showInput(type) {
        activeType = type;
        document.getElementById('modalLabel').innerText = (type === 'ØªØ°ÙƒÙŠØ±' ? 'Ø¶Ø¨Ø· ' : 'ØªØ³Ø¬ÙŠÙ„ ') + type;
        const area = document.getElementById('inputArea');
        area.innerHTML = '';
        if(type === 'Ø­ØµØ§Ø¯' || type === 'ØªØ³Ù…ÙŠØ¯') {
            area.innerHTML = `<input type="number" id="valInput" class="form-control form-control-lg text-center" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø§Ù„Ø±Ù‚Ù…">`;
        } else if(type === 'ØªØ°ÙƒÙŠØ±') {
            area.innerHTML = `<input type="text" id="valInput" class="form-control mb-2" placeholder="Ø§Ù„Ù…Ù‡Ù…Ø©: Ø±ÙŠØŒ Ø±Ø´..."><input type="date" id="dateInput" class="form-control">`;
        } else if(type === 'Ø¹Ù…Ø§Ù„Ø©') {
            area.innerHTML = `<input type="text" id="valInput" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„"><select id="statusIn" class="form-select"><option>Ø­Ø¶ÙˆØ± âœ…</option><option>Ø¥Ø¬Ø§Ø²Ø© ğŸ–ï¸</option><option>ØºÙŠØ§Ø¨ âŒ</option></select>`;
        } else {
            area.innerHTML = `<textarea id="valInput" class="form-control" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§..."></textarea>`;
        }
        dModal.show();
    }

    function handleSave() {
        const val = document.getElementById('valInput').value;
        if(!val) return;
        const f = db.farms[db.cur];
        let message = val;
        if(activeType === 'Ø¹Ù…Ø§Ù„Ø©') message = val + " (" + document.getElementById('statusIn').value + ")";
        if(activeType === 'ØªØ°ÙƒÙŠØ±') message = val + " Ù…ÙˆØ¹Ø¯: " + document.getElementById('dateInput').value;

        const log = { d: new Date().toLocaleString('ar-EG'), t: activeType, m: message, img: null };
        if(activeType === 'Ø­ØµØ§Ø¯') f.kg += parseFloat(val);

        const file = document.getElementById('fileIn').files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = e => { log.img = e.target.result; finish(f, log); };
            reader.readAsDataURL(file);
        } else finish(f, log);
    }

    function finish(f, log) {
        f.logs.push(log); save(); dModal.hide(); render();
    }

    function openSettings() { sModal.show(); }

    function createNewFarm() {
        const name = document.getElementById('newFarmName').value;
        if(name) {
            const id = 'f' + Date.now();
            db.farms[id] = { name: name, logs: [], kg: 0, stock: 0 };
            db.cur = id; save(); sModal.hide(); render();
        }
    }

    function render() {
        const f = db.farms[db.cur];
        document.getElementById('farmName').innerText = f.name;
        document.getElementById('kgView').innerText = f.kg;
        document.getElementById('logList').innerHTML = f.logs.map(l => `
            <div class="log-item d-flex gap-3">
                ${l.img ? `<img src="${l.img}" style="width:60px;height:60px;border-radius:10px;object-fit:cover" onclick="window.open(this.src)">` : '<div style="width:60px;height:60px;background:#eee;border-radius:10px;text-align:center;padding-top:15px">ğŸŒ³</div>'}
                <div class="flex-grow-1"><div class="fw-bold small text-success">${l.t}</div><div class="small text-dark">${l.m}</div><div style="font-size:10px" class="opacity-50">${l.d}</div></div>
            </div>
        `).reverse().join('');
    }

    function getWeather() {
        navigator.geolocation.getCurrentPosition(pos => {
            db.farms[db.cur].lat = pos.coords.latitude; db.farms[db.cur].lon = pos.coords.longitude;
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true`)
            .then(r => r.json()).then(d => {
                document.getElementById('weatherInfo').innerText = `Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ø¢Ù†: ${d.current_weather.temperature}Â°C`;
                document.getElementById('locStatus').innerHTML = `<i class="fas fa-check-circle"></i> ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©`;
            });
        });
    }

    function downloadReport() {
        const f = db.farms[db.cur];
        let text = `ØªÙ‚Ø±ÙŠØ± Ù…Ø²Ø±Ø¹Ø©: ${f.name}\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­ØµÙˆÙ„: ${f.kg} ÙƒØ¬Ù…\n\nØ§Ù„Ø³Ø¬Ù„Ø§Øª:\n`;
        f.logs.forEach(l => text += `[${l.d}] ${l.t}: ${l.m}\n`);
        const blob = new Blob([text], {type: 'text/plain'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Farm_Report.txt'; a.click();
    }

    function save() { localStorage.setItem('farm_pro_v8', JSON.stringify(db)); }
    function resetAll() { if(confirm("Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) { localStorage.clear(); location.reload(); } }
    
    getWeather();
    render();
</script>
</body>
</html>
