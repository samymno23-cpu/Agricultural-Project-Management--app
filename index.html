<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGRO-PRO V23 | Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø°ÙƒÙŠØ©</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --main-green: #1d4d1a; --soft-bg: #f8fdf8; }
        body { background-color: var(--soft-bg); font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; padding-bottom: 80px; }
        
        .app-page { display: none; min-height: 100vh; background: #fff; position: fixed; top: 0; left: 0; width: 100%; z-index: 2000; overflow-y: auto; padding: 20px; }
        .app-page.active { display: block; animation: fadeIn 0.3s ease; }
        
        .header-ui { background: var(--main-green); color: white; padding: 25px 15px; border-radius: 0 0 35px 35px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-grid-item { border: none; border-radius: 20px; padding: 20px 10px; color: white; display: flex; flex-direction: column; align-items: center; gap: 10px; font-weight: bold; font-size: 0.9rem; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-grid-item:active { transform: scale(0.95); }
        
        .card-stat { background: white; border-radius: 20px; padding: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: center; }
        .bottom-nav { background: white; padding: 12px; position: fixed; bottom: 0; width: 100%; display: flex; justify-content: space-around; border-top: 1px solid #eee; z-index: 1000; }
        
        .archive-item { background: #fdfdfd; border-right: 5px solid var(--main-green); border-radius: 10px; padding: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="homeUI">
    <div class="header-ui text-center">
        <h4 id="displayFarmName" class="fw-bold mb-0">...</h4>
        <div id="weatherInfo" class="small opacity-75 mt-1">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù‚Ø³...</div>
    </div>

    <div class="container mt-4 px-3">
        <div class="row g-2 mb-4">
            <div class="col-6"><div class="card-stat border-bottom border-success border-4"><small class="text-muted">Ø§Ù„Ù…Ø­ØµÙˆÙ„</small><h4 id="kgStat" class="mb-0 text-success fw-bold">0</h4></div></div>
            <div class="col-6"><div class="card-stat border-bottom border-primary border-4"><small class="text-muted">Ø§Ù„Ù…Ø®Ø²Ù†</small><h4 id="stockStat" class="mb-0 text-primary fw-bold">0</h4></div></div>
        </div>

        <div class="row g-3">
            <div class="col-4"><button class="btn-grid-item w-100" style="background:#27ae60" onclick="goToPage('opPage', 'Ø±ÙŠ')"><i class="fas fa-droplet fs-4"></i> Ø±ÙŠ</button></div>
            <div class="col-4"><button class="btn-grid-item w-100" style="background:#f39c12" onclick="goToPage('opPage', 'ØªØ³Ù…ÙŠØ¯')"><i class="fas fa-flask fs-4"></i> ØªØ³Ù…ÙŠØ¯</button></div>
            <div class="col-4"><button class="btn-grid-item w-100" style="background:#3498db" onclick="goToPage('opPage', 'Ø±Ø´')"><i class="fas fa-wind fs-4"></i> Ø±Ø´</button></div>
            <div class="col-4"><button class="btn-grid-item w-100" style="background:#e67e22" onclick="goToPage('opPage', 'ØªÙ‚Ù„ÙŠÙ…')"><i class="fas fa-cut fs-4"></i> ØªÙ‚Ù„ÙŠÙ…</button></div>
            <div class="col-4"><button class="btn-grid-item w-100" style="background:#2980b9" onclick="goToPage('opPage', 'Ø®Ø¯Ù…Ø© Ø´ØªÙˆÙŠØ©')"><i class="fas fa-snowflake fs-4"></i> Ø´ØªÙˆÙŠØ©</button></div>
            <div class="col-4"><button class="btn-grid-item w-100" style="background:#e74c3c" onclick="goToPage('opPage', 'Ø£Ø¹Ø·Ø§Ù„')"><i class="fas fa-tools fs-4"></i> Ø£Ø¹Ø·Ø§Ù„</button></div>
            <div class="col-4"><button class="btn-grid-item w-100" style="background:#2c3e50" onclick="goToPage('opPage', 'Ø­ØµØ§Ø¯')"><i class="fas fa-box-open fs-4"></i> Ø­ØµØ§Ø¯</button></div>
            <div class="col-4"><button class="btn-grid-item w-100" style="background:#8e44ad" onclick="goToPage('staffPage')"><i class="fas fa-book-open fs-4"></i> Ø¹Ù…Ø§Ù„Ø©</button></div>
            <div class="col-4"><button class="btn-grid-item w-100" style="background:#7f8c8d" onclick="goToPage('opPage', 'Ø£Ø®Ø±Ù‰')"><i class="fas fa-plus fs-4"></i> Ø£Ø®Ø±Ù‰</button></div>
        </div>
    </div>
</div>

<div id="opPage" class="app-page">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 id="opHeader" class="fw-bold mb-0"></h4>
        <button class="btn btn-dark btn-sm rounded-pill px-3" onclick="closeAllPages()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div id="opInputs"></div>
    <div class="mt-4">
        <label class="fw-bold small mb-2">ğŸ“¸ Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
        <input type="file" id="opImage" class="form-control" accept="image/*">
    </div>
    <button class="btn btn-success w-100 py-3 rounded-4 fw-bold mt-4 shadow" onclick="saveOpData()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­ÙØ¸</button>
</div>

<div id="stockPage" class="app-page">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold mb-0">ğŸ  Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²Ù†</h4>
        <button class="btn btn-dark btn-sm rounded-pill" onclick="closeAllPages()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="card p-3 bg-light border-0 mb-4 rounded-4">
        <input type="text" id="itemName" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
        <input type="number" id="itemQty" class="form-control mb-3" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
        <button class="btn btn-primary w-100 rounded-3" onclick="addToStock()">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø®Ø²Ù†</button>
    </div>
    <div id="stockListDisplay"></div>
</div>

<div id="staffPage" class="app-page">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold mb-0">ğŸ—“ï¸ Ø¯ÙØªØ± Ø§Ù„Ø¹Ù…Ø§Ù„Ø©</h4>
        <button class="btn btn-dark btn-sm rounded-pill" onclick="closeAllPages()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="card p-3 bg-light border-0 mb-3 rounded-4 text-center">
        <input type="text" id="workerName" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„">
        <div class="d-flex gap-2">
            <button class="btn btn-success flex-grow-1" onclick="logStaff('Ø­Ø¶ÙˆØ±')">Ø­Ø¶ÙˆØ±</button>
            <button class="btn btn-danger flex-grow-1" onclick="logStaff('ØºÙŠØ§Ø¨')">ØºÙŠØ§Ø¨</button>
            <button class="btn btn-info text-white flex-grow-1" onclick="logStaff('Ø¥Ø¬Ø§Ø²Ø©')">Ø¥Ø¬Ø§Ø²Ø©</button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-sm text-center small"><thead class="table-dark"><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¹Ø§Ù…Ù„</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody id="staffLogsDisplay"></tbody></table>
    </div>
</div>

<div id="archivePage" class="app-page">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold mb-0">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h4>
        <button class="btn btn-dark btn-sm rounded-pill" onclick="closeAllPages()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div id="archiveLogsDisplay"></div>
</div>

<div id="farmsPage" class="app-page">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold mb-0">ğŸŒ³ Ø¥Ø¯Ø§Ø±Ø© Ù…Ø²Ø§Ø±Ø¹ÙŠ</h4>
        <button class="btn btn-dark btn-sm rounded-pill" onclick="closeAllPages()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div id="farmsListDisplay" class="list-group mb-4"></div>
    <div class="card p-3 bg-light border-0 rounded-4">
        <input type="text" id="newFarmInput" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
        <button class="btn btn-success w-100 rounded-3" onclick="createNewFarm()">Ø¥Ø¶Ø§ÙØ© Ù…Ø²Ø±Ø¹Ø©</button>
    </div>
</div>

<div class="bottom-nav shadow-lg">
    <button class="btn text-success" onclick="closeAllPages()"><i class="fas fa-home fs-4"></i></button>
    <button class="btn text-secondary" onclick="goToPage('farmsPage')"><i class="fas fa-layer-group fs-4"></i></button>
    <button class="btn text-secondary" onclick="goToPage('stockPage')"><i class="fas fa-warehouse fs-4"></i></button>
    <button class="btn text-secondary" onclick="goToPage('archivePage')"><i class="fas fa-history fs-4"></i></button>
    <button class="btn text-secondary" onclick="generatePDFReport()"><i class="fas fa-file-pdf fs-4"></i></button>
</div>

<script>
    const DB_NAME = 'OLIVE_ERP_V23_STABLE';
    let db = JSON.parse(localStorage.getItem(DB_NAME)) || {
        cur: 'f1', farms: { 'f1': { name: "Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ø²ÙŠØªÙˆÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", logs: [], kg: 0, stock: {}, staff: [] } }
    };
    let activeOp = '';

    function goToPage(id, op = '') {
        document.querySelectorAll('.app-page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if (op) { activeOp = op; document.getElementById('opHeader').innerText = "ØªØ³Ø¬ÙŠÙ„ " + op; renderOpInputs(op); }
        if (id === 'stockPage') renderStock();
        if (id === 'staffPage') renderStaff();
        if (id === 'archivePage') renderArchive();
        if (id === 'farmsPage') renderFarms();
    }

    function closeAllPages() { document.querySelectorAll('.app-page').forEach(p => p.classList.remove('active')); renderHome(); }

    function renderOpInputs(op) {
        const f = db.farms[db.cur]; const div = document.getElementById('opInputs'); div.innerHTML = '';
        if (op === 'ØªØ³Ù…ÙŠØ¯') {
            let opts = Object.keys(f.stock).map(k => `<option value="${k}">${k} (Ù…ØªØ§Ø­: ${f.stock[k]})</option>`).join('');
            div.innerHTML = `<label class="small fw-bold">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù†:</label><select id="inp1" class="form-select mb-3 shadow-sm">${opts || '<option>Ø§Ù„Ù…Ø®Ø²Ù† ÙØ§Ø±Øº</option>'}</select>
                             <input type="number" id="inp2" class="form-control shadow-sm" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©">`;
        } else if (op === 'Ø­ØµØ§Ø¯') {
            div.innerHTML = `<input type="number" id="inp1" class="form-control shadow-sm" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø§Ù„ÙƒØ¬Ù…">`;
        } else {
            div.innerHTML = `<textarea id="inp1" class="form-control shadow-sm" rows="8" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù€ ${op} Ù‡Ù†Ø§..."></textarea>`;
        }
    }

    // ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ù„ØªØµÙÙŠØ± Ø§Ù„Ø­Ù‚ÙˆÙ„
    function saveOpData() {
        const f = db.farms[db.cur]; let msg = "";
        const v1 = document.getElementById('inp1')?.value; const v2 = document.getElementById('inp2')?.value;
        
        if (!v1 && activeOp !== 'ØªØ³Ù…ÙŠØ¯') return;

        if (activeOp === 'ØªØ³Ù…ÙŠØ¯') {
            if (f.stock[v1] >= v2) { f.stock[v1] -= v2; msg = `Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ ${v2} Ù…Ù† ${v1}`; } else { alert("Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± ÙƒØ§ÙÙŠØ©!"); return; }
        } else if (activeOp === 'Ø­ØµØ§Ø¯') { f.kg += parseFloat(v1 || 0); msg = `Ø­ØµØ§Ø¯ ${v1} ÙƒØ¬Ù…`; }
        else { msg = v1; }

        f.logs.push({ d: new Date().toLocaleString('ar-EG'), t: activeOp, m: msg });
        
        sync(); 
        clearForm(); // ØªØµÙÙŠØ± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
        closeAllPages();
    }

    function clearForm() {
        if (document.getElementById('inp1')) document.getElementById('inp1').value = "";
        if (document.getElementById('inp2')) document.getElementById('inp2').value = "";
        if (document.getElementById('opImage')) document.getElementById('opImage').value = "";
        if (document.getElementById('workerName')) document.getElementById('workerName').value = "";
        if (document.getElementById('itemName')) document.getElementById('itemName').value = "";
        if (document.getElementById('itemQty')) document.getElementById('itemQty').value = "";
    }

    function addToStock() {
        const n = document.getElementById('itemName').value, q = document.getElementById('itemQty').value;
        if(n && q) { db.farms[db.cur].stock[n] = (db.farms[db.cur].stock[n] || 0) + parseFloat(q); sync(); renderStock(); clearForm(); }
    }

    function logStaff(stat) {
        const n = document.getElementById('workerName').value; if(!n) return;
        db.farms[db.cur].staff.push({ n: n, s: stat, d: new Date().toLocaleDateString('ar-EG') });
        sync(); renderStaff(); clearForm();
    }

    function renderHome() {
        const f = db.farms[db.cur]; document.getElementById('displayFarmName').innerText = f.name;
        document.getElementById('kgStat').innerText = f.kg; document.getElementById('stockStat').innerText = Object.keys(f.stock).length;
    }

    function renderArchive() {
        const f = db.farms[db.cur];
        document.getElementById('archiveLogsDisplay').innerHTML = f.logs.map((l, i) => `
            <div class="archive-item d-flex justify-content-between align-items-center">
                <div><span class="badge bg-success mb-1">${l.t}</span><br><small>${l.m}</small><br><span class="text-muted" style="font-size:10px">${l.d}</span></div>
                <button class="btn btn-sm btn-outline-primary" onclick="editLog(${i})">ØªØ¹Ø¯ÙŠÙ„</button>
            </div>
        `).reverse().join('');
    }

    function editLog(i) {
        let f = db.farms[db.cur]; let newM = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:", f.logs[i].m);
        if(newM) { f.logs[i].m = newM; sync(); renderArchive(); }
    }

    function renderStock() {
        const f = db.farms[db.cur];
        document.getElementById('stockListDisplay').innerHTML = Object.keys(f.stock).map(k => `
            <div class="card p-3 mb-2 d-flex flex-row justify-content-between shadow-sm rounded-3"><b>${k}</b> <span class="text-success fw-bold">${f.stock[k]} ÙˆØ­Ø¯Ø©</span></div>
        `).join('');
    }

    function renderStaff() {
        const f = db.farms[db.cur];
        document.getElementById('staffLogsDisplay').innerHTML = f.staff.map(w => `<tr><td>${w.d}</td><td>${w.n}</td><td>${w.s}</td></tr>`).reverse().join('');
    }

    function renderFarms() {
        document.getElementById('farmsListDisplay').innerHTML = Object.keys(db.farms).map(id => `
            <button class="list-group-item list-group-item-action d-flex justify-content-between rounded-3 mb-1 ${id==db.cur?'active':''}" onclick="selectFarm('${id}')">
                ${db.farms[id].name} <span>${id==db.cur?'(Ø§Ù„Ø­Ø§Ù„ÙŠØ©)':''}</span>
            </button>
        `).join('');
    }

    function selectFarm(id) { db.cur = id; sync(); renderFarms(); }
    function createNewFarm() {
        let n = document.getElementById('newFarmInput').value;
        if(n) { let id = 'f'+Date.now(); db.farms[id] = { name:n, logs:[], kg:0, stock: {}, staff:[] }; db.cur = id; sync(); renderFarms(); document.getElementById('newFarmInput').value = ""; }
    }

    function generatePDFReport() {
        const f = db.farms[db.cur];
        let h = `<div dir="rtl" style="padding:20px; font-family:Arial;"><h2>ØªÙ‚Ø±ÙŠØ± Ù…Ø²Ø±Ø¹Ø©: ${f.name}</h2><table border="1" style="width:100%; border-collapse:collapse; text-align:center;">
                 <tr style="background:#eee;"><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th></tr>`;
        f.logs.forEach(l => h += `<tr><td>${l.d}</td><td>${l.t}</td><td>${l.m}</td></tr>`);
        html2pdf().from(h + "</table></div>").save('Farm_Report.pdf');
    }

    function sync() { localStorage.setItem(DB_NAME, JSON.stringify(db)); }

    navigator.geolocation.getCurrentPosition(p => {
        fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&current_weather=true`)
        .then(r => r.json()).then(d => document.getElementById('weatherInfo').innerText = `Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ø¢Ù†: ${d.current_weather.temperature}Â°C | Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø³Ø¬Ù„`);
    });

    renderHome();
</script>
</body>
</html>
